use('torneo_futbol');

//1. Consultar la plantilla (jugadores) de los equipos en cada edición de los torneos.
//En la colección equipos está todo
db.equipos.aggregate([      
    {$project:{
            "nombre_eq": 1,
            "plantilla.edicion_torneo": 1,
            "plantilla.jugadores": 1
        }
    }
]).pretty();


//- ** 2 Clasificación final en cada grupo. ** paila, aún no está


// 3. Toda la información de un partido filtrando por torneo y equipo.
//Opción 1//db.partidos.find({$or:[{"equipoLocal.nombre": "Manchester City"},{"equipoVisitante.nombre": "Manchester City"}]}).pretty();
equipo_buscar = 'Piemonte Calcio';
equipo_buscar = '2020';
db.partidos.aggregate([
    { $match: { $or: [{'equipoVisitante.nombre':equipo_buscar },{'equipoLocal.nombre':equipo_buscar}]}}
    ,{$set: 
        {'Goles Equipo Buscado':
            { $size:{$filter: {input: "$incidencias",as: "list",cond: {
                        $and:[
                            {$eq: ['$$list.nombre_equipo', equipo_buscar]},
                            {$eq: ['$$list.tipo_incidencia', "gol"]}
                        ]
                    }
                    }
                }
            },
        'Goles equipo contrario':
            { $size:{$filter: {input: "$incidencias",as: "list",cond: {
                        $and:[
                            {$ne: ['$$list.nombre_equipo', equipo_buscar]},
                            {$eq: ['$$list.tipo_incidencia', "gol"]}
                        ]
                    }
                    }
                }
            }
        }
    }
]).pretty();


//4. Dado un jugador y un torneo ver los partidos en los que participó.
//Messi
torneo = 'torneo';
jugador_buscar = '5faabc2be46ad90480d991aa';  //falta el nombre. anidar plantilla completa
db.partidos.find({
    $and:[
        {$or:[
            {'equipoVisitante.id_plantilla':jugador_buscar },
            {'equipoLocal.id_plantilla':jugador_buscar}]},
        {'torneo':torneo},    
    ]
}).pretty();


//5. Ver la información de las incidencias de un jugador en un torneo, que incluya tipo de incidencia, minuto, equipo, etc.
//Messi
torneo = 'torneo';
jugador_buscar = 'Aymeric Laporte';  //falta el nombre. anidar plantilla completa
db.partidos.aggregate([
    {$match:{$and:[
                {$or:[
                    {'equipoVisitante.id_plantilla.nombre':jugador_buscar },
                    {'equipoLocal.id_plantilla.nombre':jugador_buscar}]},
                {'torneo':torneo}
    ]}}
     ,
    {$group: { 
        _id: "$incidencias"
        } 
    }
]).pretty();

